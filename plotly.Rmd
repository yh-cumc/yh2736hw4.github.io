---
title: "R for Data Science"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 16, fig.height = 8)
library(tidyverse)
library(wordcountaddin)
library(readxl)
library(ggplot2)
library(rvest)
library(ggpubr)
library(gridExtra)
library(grid)

##Set the torelent value
tol <- 1e-5

```

* Introduction
* Data Wraggling
* Data visulization and analysis
* Data reproducing
* Discussion



## Introduction

A paper published in 2018 Nature was exploring if prominent exostosis projecting from the occipital squama is more substantial and prevalent in young adult than older age groups. The current analysis aims to reproduce the study results using original data and explore ways to further improve the data analysis in the paper. 

## Data Wraggling

The original dataset has 1221 observations and 9 variables, including sex, continuous age in years, continuous EOP and FHP in millimeter, and categorical variables derived from their continuous counterparts. 

```{r, echo = TRUE, message = FALSE}

# Part I

## Import and clean the data
mtp_original_dataset <- read_xlsx("./data/p8105_mtp_data.xlsx", 
                         col_names = TRUE, 
                         skip = 8) %>% 
  janitor::clean_names() 
## Display variable
str(mtp_original_dataset)
```

Missing value of each variable is presented in Table 1.1. 518 and 522 missing values were found in continuous eop size and categorical eop shape, respectively. 
```{r, echo = TRUE, message = FALSE}
## Check and fill in the missing values of key variables
miss_sex <- sum(is.na(mtp_original_dataset$sex))
miss_age <- sum(is.na(mtp_original_dataset$age))
miss_age_group <- sum(is.na(mtp_original_dataset$age_group))
miss_eop_size_mm <- sum(is.na(mtp_original_dataset$eop_size_mm))
miss_eop_size <- sum(is.na(mtp_original_dataset$eop_size))
miss_eop_vis_class <- sum(is.na(mtp_original_dataset$eop_visibility_classification))
miss_eop_shape <- sum(is.na(mtp_original_dataset$eop_shape))
miss_fhp_size_mm <- sum(is.na(mtp_original_dataset$fhp_size_mm))
miss_fhp_category <- sum(is.na(mtp_original_dataset$fhp_category))

## Check frequecy of miss data value table
miss_value_dataset <- tibble(
  variable_name = c("sex", "age", "age group", "eop size (mm)", "eop size", 
                     "eop visibility classification", "eop shape", "fhp size (mm)", "fhp category"),
  total_numer_of_missing_value = c(miss_sex, miss_age, miss_age_group, miss_eop_size_mm,    miss_eop_size, miss_eop_vis_class, miss_eop_shape, miss_fhp_size_mm, miss_fhp_category)
)

knitr::kable(miss_value_dataset, 
             align=c(rep('c',times=2)), 
             caption = "Table 1.1") 
  

```




```{r, part2, echo = FALSE, message = FALSE, warning = FALSE}

# Part II

# For the convenience of formatting, some new variables were created;
# To check the consistency in problem3, new categorical variables for age, EOP, and FHP were created based on original continuous variable. The corrected variables are only used in problem 3.

mtp_cleaned_dataset <- mtp_original_dataset %>% 
  mutate(
    sex = as.integer(sex),
    age = as.integer(age),
    age_group = as.factor(age_group),
    eop_size_mm = as.double(eop_size_mm),
    eop_size = as.factor(eop_size),
    eop_visibility_classification = as.factor(eop_visibility_classification),
    eop_shape = as.integer(eop_shape),
    fhp_size_mm = as.double(fhp_size_mm),
    fhp_category = as.factor(fhp_category)
  ) %>%  
  mutate(
    gender = case_when(
      sex == 1  ~  "Males",
      sex == 0  ~  "Females",
      TRUE        ~  "NA"
    ),                                      
    age_range = case_when(
      age_group == 1    ~ "< 18",
      age_group == 2    ~ "18-30 Years",
      age_group == 3    ~ "30s",
      age_group == 4    ~ "40s",
      age_group == 5    ~ "50s",
      age_group == 6    ~ ">60",
      age_group == 7    ~ ">60",
      age_group == 8    ~ ">60",
      TRUE              ~ "NA"
    ),                                     
    eop_size_range = case_when(
      eop_size == 0    ~ "0-5mm",
      eop_size == 1    ~ "5-10mm",
      eop_size == 2    ~ "10-15mm",
      eop_size == 3    ~ "15-20mm",
      eop_size == 4    ~ "20-25mm",
      eop_size == 5    ~ ">25mm",
      TRUE             ~ "NA"
    ),                                     
    eop_visibility_range = case_when(
      eop_visibility_classification == 0      ~ "eop size 0 mm",
      eop_visibility_classification == 1      ~ "0 < eop size mm <= 5",
      eop_visibility_classification == 2      ~ "eop size >= 5 mm",
      TRUE                                    ~ "NA"
    ),                                         
    fhp_category_range = case_when(
      fhp_category == 0    ~ "0<= fhp size < 10 mm",
      fhp_category == 1    ~ "10<= fhp size < 20 mm",
      fhp_category == 2    ~ "20<= fhp size < 30 mm",
      fhp_category == 3    ~ "30<= fhp size < 40 mm",
      fhp_category == 4    ~ "40<= fhp size < 50 mm",
      fhp_category == 5    ~ "50<= fhp size < 60 mm",
      fhp_category == 6    ~ "60<= fhp size < 70 mm",
      fhp_category == 7    ~ "70<= fhp size < 80 mm",
      fhp_category == 8    ~ "80<= fhp size < 90 mm",
      TRUE                 ~ "NA"
    )                                           
  ) %>% 
  select(sex, gender, age, age_group, age_range, 
         eop_size_mm, eop_size, eop_size_range, 
         eop_visibility_classification, 
         eop_visibility_range, 
         eop_shape, fhp_size_mm, fhp_category, 
         fhp_category_range) %>%              
  mutate(
    gender = factor(gender, 
                    levels = c("Females", 
                               "Males")),    
    age_range = factor(age_range, 
                       levels = c("< 18", 
                                  "18-30 Years", 
                                  "30s", 
                                  "40s", 
                                  "50s", 
                                  ">60")),     
    eop_size_range = factor(eop_size_range, 
                            levels = c("0-5mm", 
                                       "5-10mm", 
                                       "10-15mm", 
                                       "15-20mm", 
                                       ">25mm")),      
    eop_visibility_range = factor(eop_visibility_range, 
                                  levels = c("eop size 0 mm", 
                                             "0 < eop size mm <= 5", 
                                             "eop size >= 5 mm")),   
    fhp_category_range = factor(fhp_category_range, 
                                levels = c("0<fhp size < 10 mm", 
                                           "10<= fhp size < 20 mm", 
                                           "20<= fhp size < 30 mm", 
                                           "30<= fhp size < 40 mm", 
                                           "40<= fhp size < 50 mm", 
                                           "50<= fhp size < 60 mm", 
                                           "60<= fhp size < 70 mm", 
                                           "70<= fhp size < 80 mm", 
                                           "90<= fhp size < 90 mm")) 
  )


## Basic statistics for participants' age and gender distribution

# Age group by gender

age_gender_distribution <- mtp_cleaned_dataset %>% 
  group_by(gender, age_range) %>% 
  summarize(
    participant = n()
  )

## Age group for the entire participants

total_participant <- as.integer(sum(age_gender_distribution$participant))


```


The study cohort has 607(49.7%) males and 614 (50.3%) females. Median age was 45 years (IQR:31-60) (Table 1.2.1).

```{r, echo = TRUE, message = FALSE, warning = FALSE}

## Females and Males participants
females_participant <- mtp_cleaned_dataset %>% 
  select(gender, age) %>% 
  filter(gender == "Females")

males_participant <- mtp_cleaned_dataset %>% 
  select(gender, age) %>% 
  filter(gender == "Males")


### percentage 
females_percentage <- round(nrow(females_participant)/(nrow(females_participant) + nrow(males_participant)) *100, 
                                                  digits = 1)

males_percentage <- round(nrow(males_participant)/(nrow(females_participant) + nrow(males_participant)) *100, 
                                                  digits = 1)

### Median age
females_med_age <- median(females_participant$age)
males_med_age <- median(males_participant$age)

##IQR
femals_iqr <- IQR(females_participant$age)
male_iqr <- IQR(males_participant$age)

### table 1.2 
table_age_analysis <- tibble(
  Gender = c("Femals", "Males"),
  Participant_number = c(nrow(females_participant), nrow(males_participant)),
  percentage = c(females_percentage, males_percentage),
  median_age =c(females_med_age, males_med_age),
  iqr = c(femals_iqr, male_iqr)
)

knitr::kable(table_age_analysis, 
             align=c(rep('c',times=5)), 
             caption = "Table 1.2.1") 

```

 Age distribution in males and females were similar. Approximately one quarter of subjects were aged between 18 to 30 years (Table 1.2.2). Two patients aged <18 were excluded from final analysis.
```{r, table1.2.2, echo = FALSE, message = FALSE, warning = FALSE}

## Gender and age distribution
gender_age_distribution <- mtp_cleaned_dataset %>% 
  select(age_group, gender, age_range) %>% 
  group_by(age_group, gender) %>% 
  summarize(
    n = n()
  ) %>% 
  mutate(
    age_range = case_when(
      age_group == 1    ~ "< 18",
      age_group == 2    ~ "18-30 Years",
      age_group == 3    ~ "30s",
      age_group == 4    ~ "40s",
      age_group == 5    ~ "50s",
      age_group == 6    ~ ">60",
      age_group == 7    ~ ">60",
      age_group == 8    ~ ">60",
      TRUE              ~ "NA"
    )
  ) %>% 
  pivot_wider(
    names_from = "gender",
    values_from = "n"
  ) %>% 
  janitor::clean_names() %>% 
  mutate(
    females_percentage = round(females / nrow(females_participant) *100,
                               digits = 2),
    males_percentage = round(males / nrow(males_participant) *100,  
                             digits = 2)
  ) %>% 
  select(age_group, age_range, females_percentage, males_percentage)


knitr::kable(gender_age_distribution, 
             align=c(rep('c',times=4)), 
             caption = "Table 1.2.2") 


```


Missing values of EOP and FHP were inputed with zero. A right-skewed distribution of EOP and FHP was found in histograms (Figure 1). 

```{r, figure1and2, echo = TRUE, message = FALSE, warning = FALSE}
## Impute all missing value with 0 for variables "EOP Size (mm)", eop_shape, and fhp_size 

mtp_cleaned_dataset$eop_size_mm[is.na(mtp_cleaned_dataset$eop_size_mm)] <- 0
mtp_cleaned_dataset$eop_shape[is.na(mtp_cleaned_dataset$eop_shape)] <- 0
mtp_cleaned_dataset$fhp_size_mm[is.na(mtp_cleaned_dataset$fhp_size_mm)] <- 0

## FHP size counte
eop_size_distribution <- mtp_cleaned_dataset %>% 
  select(eop_size_mm)

figure1 <- ggplot(eop_size_distribution, aes(x = eop_size_mm)) +
  geom_histogram(binwidth = 2,
                 color = "black", 
                 aes(fill = ..count..)) +
  viridis::scale_fill_viridis(
    name = "Count",
    discrete = FALSE
  ) +
  geom_density(aes(y = 2 * ..count..)) +
  labs(
    title = "EOP size (mm) count histogram",
    x = "EOP size (mm)",
    y = "Count"
  ) +
  theme(
    axis.text = element_text(size=14),
    axis.title.x.bottom = element_text(face="bold", color="#993333", 
                           size=14), 
    axis.title.y.left = element_text(face="bold", color="#993333", 
                           size=14),
    title = element_text(face="bold", color="#993333", 
                           size=20)
  ) +
   scale_y_continuous(breaks=seq(0,600,50))

fhp_size_distribution <- mtp_cleaned_dataset %>% 
  select(gender, fhp_size_mm)


figure2 <- ggplot(fhp_size_distribution, aes(x = fhp_size_mm)) +
  geom_histogram(binwidth = 2,
                 color = "black", 
                 aes(fill = ..count..)) +
  viridis::scale_fill_viridis(
    name = "Count",
    discrete = FALSE
  ) +
  geom_density(aes(y = 2 * ..count..)) +
  labs(
    title = "FHP size (mm) count histogram",
    x = "FHP size (mm)",
    y = "Count"
  ) +
  theme(
    axis.text = element_text(size=14),
    axis.title.x.bottom = element_text(face="bold", color="#993333", 
                           size=14), 
    axis.title.y.left = element_text(face="bold", color="#993333", 
                           size=14),
    title = element_text(face="bold", color="#993333", 
                           size=20)
  ) +
  scale_y_continuous(breaks=seq(0,90,10))

##drawing a two panel plot
fig1and2 <- ggarrange(figure1, figure2, ncol = 2, nrow = 1)

##add title
annotate_figure(
  fig1and2, 
  top = text_grob("Figure 1", 
                  color = "blue",
                  face = "bold", 
                  size = 20)
)

```

Consistency between categorical and continuous variables was checked (Table 1.3.1 to 1.3.4). Misclassifications of categorical variables can be notified if the range of a continuous variable is inconsistent with the label of its categorical counterpart. For example in Table 1.3.1, minimum and maximum values of eop size in category 3,4,5 are inconsistent with the corresponding values in the lable. A category of 14.6 was miscoded. Such inconsisitency was also found in fhp category 2, a miscoded value of 30.8., and the allocations of cutoff values.


```{r, table1.3.1, echo = TRUE, message = FALSE, warning = FALSE}
age_group_error <- mtp_cleaned_dataset %>% 
  select(age, age_group, age_range) %>% 
  group_by(age_group) %>% 
  summarize(
    n = n(),
    age_min = min(age),
    age_max = max(age)
  ) %>% 
  mutate(
    age_range = case_when(
      age_group == "1"     ~ "< 18",
      age_group == "2"     ~ "18 <= age <= 30",
      age_group == "3"     ~ "31 <= age <= 40",
      age_group == "4"     ~ "41 <= age <= 50",
      age_group == "5"     ~ "51 <= age <= 60",
      age_group == "6"     ~ "61 <= age <= 70",
      age_group == "7"     ~ "71 <= age <= 80",
      age_group == "8"     ~ "81 <= age <= 90",
      TRUE                 ~ "NA"
    )
  ) %>% 
  select(age_group, age_range, n, age_min, age_max)

knitr::kable(age_group_error, 
             align=c(rep('c',times=4)), 
             caption = "Table 1.3.1") 
```


```{r, table1.3.2, echo = FALSE, message = FALSE, warning = FALSE}
eop_size_error <- mtp_cleaned_dataset %>% 
  select(eop_size, eop_size_mm) %>% 
  group_by(eop_size) %>% 
  summarize(
    n = n(),
    eop_size_mm_min = min(eop_size_mm),
    eop_size_mm_max = max(eop_size_mm)
  ) %>% 
  mutate(
    eop_size = factor(eop_size, levels = c("0","1", "2", "3", "4", "5", "14.6"))
    ) %>% 
  arrange(eop_size) %>% 
  mutate(
    eop_mm_range = case_when( 
      eop_size == 0    ~ "0 <= eop size (mm) < 5mm",
      eop_size == 1    ~ "5 <= eop size (mm) < 10mm",
      eop_size == 2    ~ "10 <= eop size (mm) < 15mm",
      eop_size == 3    ~ "15 <= eop size (mm) < 20mm",
      eop_size == 4    ~ "20 <= eop size (mm) < 25mm",
      eop_size == 5    ~ "25mm <= eop size (mm)",
      TRUE               ~ "NA"
    )
  ) %>% 
  select(eop_size, eop_mm_range, n, eop_size_mm_min, eop_size_mm_max)


knitr::kable(eop_size_error, 
             align=c(rep('c',times=4)), 
             caption = "Table 1.3.2") 
```

```{r, table1.3.3, echo = FALSE, message = FALSE, warning = FALSE}
eop_visib_class_error <- mtp_cleaned_dataset %>% 
  select(eop_size_mm, eop_visibility_classification) %>% 
  group_by(eop_visibility_classification) %>% 
  summarize(
    n = n(),
    eop_size_mm_min = min(eop_size_mm),
    eop_size_mm_max = max(eop_size_mm)
  ) %>% 
  mutate(
    eop_size_mm_range = case_when(
      eop_visibility_classification == "0"        ~ "eop_size_mm = 0mm",
      eop_visibility_classification == "1"        ~ "0 < eop_size_mm <= 5mm",
      eop_visibility_classification == "2"        ~ "5mm < eop_size_mm",
      TRUE                                        ~ "NA"
      )
  ) %>% 
  select(eop_visibility_classification, eop_size_mm_range, n, eop_size_mm_min, 
         eop_size_mm_max)

knitr::kable(eop_visib_class_error, 
             align=c(rep('c',times=4)), 
             caption = "Table 1.3.3") 

```

```{r,table1.3.4, echo = FALSE, message = FALSE, warning = FALSE}
fhp_cat_error <- mtp_cleaned_dataset %>% 
  select(fhp_size_mm, fhp_category) %>% 
  group_by(fhp_category) %>% 
  summarize(
    n = n(),
    fhp_size_mm_min = min(fhp_size_mm),
    fhp_size_mm_max = max(fhp_size_mm)
  ) %>% 
  mutate(
    fhp_category = factor(fhp_category, 
                          levels = c("0", "1", "2", "3", "4", "5", "6", "7", "30.8"))
  ) %>% 
  arrange(fhp_category) %>% 
  mutate(
    fhp_size_mm_range = case_when(
      fhp_category == 0             ~ "0 <= fhp_size_mm < 10mm",
      fhp_category == 1             ~ "10 <= fhp_size_mm < 20mm", 
      fhp_category == 2             ~ "20 <= fhp_size_mm < 30mm",
      fhp_category == 3             ~ "30 <= fhp_size_mm < 40mm",
      fhp_category == 4             ~ "40 <= fhp_size_mm < 50mm",
      fhp_category == 5             ~ "50 <= fhp_size_mm < 60mm",
      fhp_category == 6             ~ "60 <= fhp_size_mm < 70mm",
      fhp_category == 7             ~ "70 <= fhp_size_mm < 80mm",
      TRUE                          ~ "NA"
    )
  ) %>% 
  select(fhp_category, fhp_size_mm_range, n, fhp_size_mm_min, fhp_size_mm_max)

knitr::kable(fhp_cat_error, 
             align=c(rep('c',times=4)), 
             caption = "Table 1.3.4") 


```


```{r, echo = FALSE, message = FALSE}

##data input error in "age group" variable

##add a variable "age_group_correct" and caculate its value based on variable "age" 

##compare the variable "age_group_correct" with "age_group"
age_group_check <- mtp_cleaned_dataset %>% 
  select(age, age_group) %>% 
  mutate(
    age_group_correct = case_when(
      age >= 0  & age < 18        ~ '1',
      age >= 18 & age <= 30       ~ '2',
      age >= 31 & age <= 40       ~ '3',
      age >= 41 & age <= 50       ~ '4',
      age >= 51 & age <= 60       ~ '5',
      age >= 61 & age <= 70       ~ '6',
      age >= 71 & age <= 80       ~ '7',
      age >= 81 & age <= 90       ~ '8',
      TRUE                        ~ 'NA'
    )
  ) %>% 
  mutate(
    is_age_group_right = (as.integer(age_group) == as.integer(age_group_correct))
  ) %>% 
  filter(
    is_age_group_right == FALSE
  ) 

##add a variable "eop_size_correct" and caculate its value based on variable "eop_size_mm"
##compare the variable "eop_size_correct" with "eop_size"
eop_size_check <- mtp_cleaned_dataset %>% 
  select(eop_size_mm, eop_size) %>% 
  mutate(
    eop_size_correct = case_when(
      eop_size_mm >= (0-tol) & eop_size_mm < (5-tol)            ~ '0',
      eop_size_mm >= (5-tol) & eop_size_mm < (10-tol)           ~ '1',
      eop_size_mm >= (10-tol) & eop_size_mm < (15-tol)          ~ '2',
      eop_size_mm >= (15-tol) & eop_size_mm < (20-tol)          ~ '3',
      eop_size_mm >= (20-tol) & eop_size_mm < (25-tol)          ~ '4',
      eop_size_mm >= (25-tol)                                   ~ '5',
      TRUE                                                      ~ 'NA'
    )
  ) %>% 
  mutate(
    is_eop_size_right = as.character(eop_size) == eop_size_correct
  ) %>% 
  filter(is_eop_size_right == FALSE)

##add a variable "eop_vis_classify_correct" and caculate its value based on variable "eop_size_mm"
##compare the variable "eop_visibility_classification" with "eop_vis_classify_correct"
eop_vis_classfica_check <- mtp_cleaned_dataset %>% 
  select(eop_size_mm, eop_visibility_classification) %>% 
  mutate(
    eop_vis_classify_correct = case_when(
      eop_size_mm == (0 - tol)                             ~ "0",
      eop_size_mm > (0 - tol) & eop_size_mm <= (5 - tol)   ~ "1",
      eop_size_mm >= (5 - tol)                             ~ "2",
      TRUE                                                 ~ "NA"
    ) 
  ) %>% 
  mutate(
    is_eop_vis_classify_right = as.character(eop_visibility_classification) == eop_vis_classify_correct
  ) %>% 
  filter(is_eop_vis_classify_right == FALSE)

##add a variable "fhp_cat_correct" and caculate its value based on variable "fhp_size_mm"
##compare the variable "fhp_category" with "fhp_cat_correct"

fhp_cat_check <- mtp_cleaned_dataset %>% 
  select(fhp_size_mm, fhp_category) %>% 
  mutate(
    fhp_cat_correct = case_when(
      fhp_size_mm >= (0 - tol) & fhp_size_mm < (10 - tol)          ~ "0",
      fhp_size_mm >= (10 - tol) & fhp_size_mm < (20 - tol)         ~ "1",
      fhp_size_mm >= (20 - tol) & fhp_size_mm < (30 - tol)         ~ "2",
      fhp_size_mm >= (30 - tol) & fhp_size_mm < (40 - tol)         ~ "3",
      fhp_size_mm >= (40 - tol) & fhp_size_mm < (50 - tol)         ~ "4",
      fhp_size_mm >= (50 - tol) & fhp_size_mm < (60 - tol)         ~ "5",
      fhp_size_mm >= (60 - tol) & fhp_size_mm < (70 - tol)         ~ "6",
      fhp_size_mm >= (70 - tol) & fhp_size_mm < (80 - tol)         ~ "7",
      fhp_size_mm >= (80 - tol) & fhp_size_mm < (90 - tol)         ~ "8",
      fhp_size_mm >= (90 - tol) & fhp_size_mm < (100 - tol)        ~ "9",
      TRUE                                                         ~ "NA"
    )
  ) %>% 
  mutate(
    is_fhp_cat_right = as.character(fhp_category) == fhp_cat_correct
  ) %>% 
  filter(is_fhp_cat_right == FALSE)

```

The total number of inconsistent value of categorical variable are `r nrow(age_group_check)` in age_group, `r nrow(eop_size_check)` in eop_size, `r nrow(eop_vis_classfica_check)` in eop_visibility_classification and `r nrow(fhp_cat_check)` in fhp_category.

## Data visulization and analysis

Since EOP is not normally distributed, boxplots were used to improve published Figure 3 and compare median and IQR by age group and sex in Figure 2.1, suggesting a diffirence of median FHP between female and male increasing from young to old age group. A figure with double axies was produced to improve published Figure 4, including the count of subjects with EEOP in left y-axis and the proportion at the right y-axis in Figure 2.2. Males do have a higher risk of EEOP than females at all age sub-groups. The risk of EEOP in males decreased from 92% in 18-30 years age group to 74% in >60 years group; and the risk in females decreased from 53% to 34%.   


```{r, echo = TRUE, message = FALSE, warning = FALSE, fig.width=12, fig.height=6}
##select the data and delete the rows which age < 18
fig3_dataset <- mtp_cleaned_dataset %>% 
  select(gender, age_range, fhp_size_mm) %>% 
  mutate(
    age_range = forcats::fct_relevel(age_range)
  ) %>% 
  subset(age_range != "< 18") 
  
##select the data and add variable to check the value of eop size
fig4_dataset <- mtp_cleaned_dataset %>% 
  select(gender, age_range, eop_size) %>% 
  mutate(
    is_eeop = case_when(
      as.integer(eop_size) == 0          ~ "FALSE",
      as.integer(eop_size) == 1          ~ "FALSE",
      as.integer(eop_size) >  1          ~ "TRUE",
      TRUE                               ~ "NA"
    )
  ) %>% 
  group_by(gender, age_range) %>% 
  summarize(
    n = n(), 
    n_eeop = sum(as.logical(is_eeop)),
    eeop_rate = n_eeop / n,
    eeop_percenty = round(eeop_rate, digits = 2) * 100
  ) %>% 
  subset(age_range != "< 18")

##figure 3 update
figure3 <- ggplot(fig3_dataset, aes(x = age_range, 
                                    y = fhp_size_mm)) +
  geom_boxplot(aes(color = gender)) +
  theme(legend.position = c(0.15, 0.90), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(color = "grey")) +
  labs(fill = "") +
  xlab("Age Group (years)") +
  ylab("Forward Head Protraction Size (mm)") +
  coord_cartesian(ylim = c(0, 80)) +
  theme(
    axis.text = element_text(size=14),
    axis.title.x.bottom = element_text(face="bold", color="#993333", 
                           size=14), 
    axis.title.y.left = element_text(face="bold", color="#993333", 
                           size=14)
  ) +
  scale_y_continuous(breaks=seq(0,80,10))

##figure 4 update
figure4 <- ggplot(fig4_dataset) +
  geom_point(aes(x = age_range, 
                 y = n_eeop, 
                 group = gender,
                 color = factor(gender), 
                 shape = factor(gender)),
             size = 5,
             show.legend = TRUE) +
  geom_line(aes(x = age_range, 
                y = n_eeop, 
                color = gender,
                group = gender), 
            size = 1, 
            show.legend = TRUE) +
  geom_col(aes(x = age_range, y = eeop_percenty, fill = gender, alpha = 0.4, color = gender), 
           position = "dodge", 
           stat = "identity", 
           show.legend = TRUE) +
  scale_y_continuous(
    breaks = seq(0, 180, 10),
    name = "EEOP Count", 
    sec.axis = sec_axis(~., 
                        breaks = seq(0, 100, 10),
                        name =  "EEOP Ratio % of Males and Female in dif age group", 
                        labels = function(eeop_percenty) {paste0(round(eeop_percenty, 0), "%")}
                        )
  ) +
  theme(legend.position = c(0.6, 0.85), 
        legend.direction = "horizontal",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(color = "grey",),
        axis.text = element_text(size=14), 
        axis.title.x.bottom = element_text(face="bold", color="#993333", 
                           size=14), 
        axis.title.y.left = element_text(face="bold", color="#993333", 
                           size=14),
        axis.title.y.right = element_text(face="bold", color="#993333", 
                           size=14)
        ) +
  labs(fill = "") +
  xlab("Age Group (years)") 

##drawing a two panel plot
ggarrange(figure3, figure4, ncol = 2, nrow = 1,
          labels = c("Figure 2.1 ", 
                     "Figure 2.2 "))



```


To examine the assocaition between FHP and EOP size, a series of scatter plots are generated, stratified by age group and gender (Figure3.1). In the scatter plot of FHP and EOP in the entire study cohort(Figure3.2), a positive association between FHP and EOP was observed. After stratified by sex and age group, no association pattern was observed in females across age groups,but there seems postive association between FHP and EOP within each age group for males. 


```{r, echo = TRUE, message = FALSE, warning = FALSE}
## select the 4 column "fhp_size_mm", "eop_size_mm", "gender" and "age_range"
## delete the row with "age_rang" equel to "<18"
fhp_vs_eop = mtp_cleaned_dataset %>% 
  select(fhp_size_mm, eop_size_mm, gender, age_range) %>% 
  filter(age_range != "< 18")

##Figurue 4
figure5 <- fhp_vs_eop %>% 
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm)) + 
  geom_point() +
  geom_smooth() +
  facet_grid(gender ~ age_range) +
  theme(
    plot.title = element_text(hjust = 0.5)
  ) +
  xlab("FHP size (mm)") +
  ylab("EOP size (mm)") +
  theme(
    axis.text = element_text(size=14),
    axis.title.x.bottom = element_text(face="bold", color="#993333", 
                           size=14), 
    axis.title.y.left = element_text(face="bold", color="#993333", 
                           size=14),
    title = element_text(face="bold", color="#993333", 
                           size=20)
  )

figure6 <- mtp_cleaned_dataset %>% 
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm)) +
  geom_point() +
  geom_smooth() +
  xlab("FHP size (mm)") +
  ylab("EOP size (mm)") +
  theme(
    axis.text = element_text(size=14),
    axis.title.x.bottom = element_text(face="bold", color="#993333", 
                           size=14), 
    axis.title.y.left = element_text(face="bold", color="#993333", 
                           size=14),
    title = element_text(face="bold", color="#993333", 
                           size=20)
  )

##drawing a two panel plot
ggarrange(figure5, figure6, ncol = 1, nrow = 2, 
          labels = c("Figure 3.1 ", 
                     "Figure 3.2 "))

```

Linear regression modes were built to justify the assocation observed in the graph. In an univariate linear regression model, the crude association between FHP and EOP was significant with an estimate 0.09379 (ste:0.01517) and a p-value <0.0001. A multivarailbe linear regression model including sex, age group, and FHP indicates that FHP and sex are statistically associated with EOP at the significant level of p-value < 0.0001 while there is no association between age group and EOP.
``
```{r, lmanalysis, echo = TRUE, message = FALSE, warning = FALSE}
### lm EOP size (mm) ~ FHP size (mm)
eop_lm_fhp <- lm(eop_size_mm ~ fhp_size_mm, data = mtp_cleaned_dataset)

### display result
summary(eop_lm_fhp)

### lm EOP size (mm) ~ FHP size (mm) + age_group + gender
eop_lm_fhp_age_sex <- lm(eop_size_mm ~ fhp_size_mm + age_group + gender, 
                         data = mtp_cleaned_dataset)
### display result
summary(eop_lm_fhp_age_sex)

```



## Data reproducing

Analysis based on original continuous variables suggests some different results from what authors reported. As shown in Table 3.1 and 3.2, the number of patients in each age group is different, but the mean and std of FHP are similar. The risk for EEOP (size of EDP > 5mm) is 32.19% in original data versus 33% in the paper. The risk for FHP >40 mm among subjects >60 years is 32.46% versus 34.5% in the paper. The total number of patients in original dataset is 1221 versus 1200 in the paper.


```{r, echo = FALSE, message = FALSE, warning = FALSE}
participant_per_age_group <- mtp_cleaned_dataset %>% 
  select(age) %>% 
  mutate(
    participant_age_group = case_when(
      age < 18                        ~ "<18",
      age >= 18 & age <= 30           ~ "18-30",
      age >= 31 & age <= 40           ~ "31-40",
      age >= 41 & age <= 50           ~ "41-50",
      age >= 51 & age <= 60           ~ "51-60",
      age >= 61                       ~ ">60",
      TRUE                            ~ "NA"
    )
  ) %>% 
  group_by(participant_age_group) %>% 
  summarize(
    participant_of_age_group_from_original_data = n()
  ) %>% 
  mutate(
    participant_age_group = factor(participant_age_group, 
                                   levels = c("<18", 
                                              "18-30", 
                                              "31-40", 
                                              "41-50", 
                                              "51-60", 
                                              ">60"))
  ) %>% 
  subset(participant_age_group != "<18") %>% 
  arrange(participant_age_group) %>% 
  mutate(
    participant_of_age_group_from_article = c(300, 200, 200, 200, 300)
  )

knitr::kable(participant_per_age_group, 
             align=c(rep('c',times=3)), 
             format = "pandoc",
             caption = "Table 3.1") 



##caculate the mean for fhp size with the original data

mean_of_fhp = as.integer(mean(mtp_cleaned_dataset$fhp_size_mm, na.rm = TRUE))

##caculate the standard deviations for fhp size with the original data
sd_of_fhp = sd(mtp_cleaned_dataset$fhp_size_mm, na.rm = TRUE)

table_mean_sd_of_fhp <- tibble(
  mean_sd_fhp_from_original_data = c(mean_of_fhp, sd_of_fhp),
  mean_sd_fhp_from_article = c(26, NA)
)

##caculate the mean and sd from available data
table_mean_sd_of_fhp_gender <- mtp_cleaned_dataset %>% 
  select(gender, fhp_size_mm) %>% 
  group_by(gender) %>% 
  summarize(
    mean_fhp = mean(fhp_size_mm, na.rm = TRUE),
    sd_fhp = sd(fhp_size_mm, na.rm = TRUE)
  ) %>% 
  pivot_longer(
    mean_fhp:sd_fhp,
    names_to = "type", 
    values_to = "from_original_data"
  ) %>% 
  mutate(
    from_article = c(24, 11, 28, 15)
  )

##table the result of mean and Sd of FHP
knitr::kable(table_mean_sd_of_fhp_gender, 
             align=c(rep('c',times=4)), 
             format = "pandoc",
             caption = "Table 3.2") 

##caculate EEOP percentage 
eeop_percentage <- mtp_cleaned_dataset %>% 
  select(eop_size_mm) %>% 
  mutate(
    is_eeop = case_when(
      eop_size_mm >= (0-tol) & eop_size_mm <= (10-tol)       ~ "FALSE",
      eop_size_mm > (10-tol)                                 ~ "TRUE",
      TRUE                                                   ~ "NA"
    )
  ) %>% 
  group_by(is_eeop) %>% 
  summarize(
    n = n()
  ) %>% 
  mutate(
    percentage = round(n/nrow(mtp_cleaned_dataset) *100, digits = 2)
  ) %>% 
  filter(is_eeop == TRUE)

## caculate the percentage of FHP > 40mm among old people(over 60 years)  

fhp_larg_than_40mm_among_old_percentage <- mtp_cleaned_dataset %>% 
  select(age, fhp_size_mm) %>% 
  filter(age > 60) %>% 
  mutate(
    is_fhp_large_than_40mm = case_when(
      fhp_size_mm <= (40 - tol)             ~ "FALSE",
      fhp_size_mm > (40 - tol)              ~ "TRUE",
      TRUE                                  ~ "NA"
    )
  ) %>% 
  group_by(is_fhp_large_than_40mm) %>% 
  summarize(
    n = n()
  ) %>% 
  mutate(
    percentage = round(n/sum(n) * 100, digits = 2)
  ) %>% 
  filter(
    is_fhp_large_than_40mm == TRUE
  )

```


## Discussion

The inconsistency between current analysis and what reported in the paper suggests that data integirty, variable misclassification, ignoring data distribution are big issues that may lead to invalid conclusions. The current analysis found that there may be possitive association between FHP and sex and EOP, but no assicaition between age group and EOP. The linearity assumption is needed for the linear model. The exploration of spline transformation model is neccessary for future analysis. Additionally, the association between FHP, age group, sex and EOP can be confounded by other factors umeasured in the dataset.


```{r, echo = FALSE, message = FALSE}
##Count the word of report
wordcountaddin::text_stats(filename = "plotly.Rmd")

```


